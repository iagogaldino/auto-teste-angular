<div class="app-container">
  <!-- Header -->
  <mat-toolbar color="primary" class="app-header">
    <mat-toolbar-row>
      <div class="brand">
        <svg id="logo-ai" class="app-logo" aria-labelledby="logo-ai-title logo-ai-desc" width="139" height="24" viewBox="0 0 139 24" fill="none" xmlns="http://www.w3.org/2000/svg"><title id="logo-ai-title">Logo StackSpot AI (Intelig√™ncia Artificial)</title><desc id="logo-ai-desc">Logo da StackSpot do lado esquerdo e do lado direito escrito "StackSpot" na cor branca e "AI" na cor laranja.</desc><g clip-path="url(#clip0_7262_63725)"><path d="M73.7006 8.97522H71.2213L68.0266 13.0292C67.5949 13.5363 67.6121 14.0062 68.0266 14.5306L71.4557 18.879H74.1299L69.8941 13.6723L73.7006 8.97522Z" fill="var(--light-contrastText)"></path><path d="M76.878 8.8194C76.878 7.78302 77.6774 6.99893 79.1427 6.99893C80.5218 6.99893 81.4025 7.85722 81.5456 9.09395H83.8127C83.6203 6.75158 81.8663 4.94348 79.1427 4.94348C76.4192 4.94348 74.6134 6.60812 74.6134 8.77982C74.6134 13.6525 81.7577 12.2254 81.7577 15.2578C81.7577 16.2571 80.9584 17.0585 79.3179 17.0585C77.6774 17.0585 76.7029 16.079 76.5647 14.6716H74.3C74.416 17.2366 76.2712 19.1139 79.2982 19.1139C82.3251 19.1139 84.0224 17.4295 84.0224 15.1985C84.0224 10.2664 76.878 11.7925 76.878 8.81692V8.8194Z" fill="var(--light-contrastText)"></path><path d="M90.2812 8.74023C88.9663 8.74023 88.1547 9.46743 87.6785 10.1575C87.4664 10.4642 86.9878 10.3381 86.9508 9.96707L86.8472 8.97521H85.2461V22.4036H87.3924V18.4609C87.3924 18.1245 87.8068 17.9564 88.0338 18.2037C88.4655 18.6761 89.1661 19.1164 90.2837 19.1164C92.7235 19.1164 94.8328 16.9447 94.8328 13.9296C94.8328 10.9144 92.7235 8.74271 90.2837 8.74271L90.2812 8.74023ZM90.0468 17.1178C88.6209 17.1178 87.3924 15.8267 87.3924 13.9271C87.3924 12.0275 88.6234 10.7363 90.0468 10.7363C91.4703 10.7363 92.7013 12.0275 92.7013 13.9271C92.7013 15.8267 91.4728 17.1178 90.0468 17.1178Z" fill="var(--light-contrastText)"></path><path d="M100.66 8.74023C97.9857 8.74023 95.7605 11.0307 95.7605 13.9271C95.7605 16.8235 97.9857 19.1139 100.66 19.1139C103.334 19.1139 105.559 16.8037 105.559 13.9271C105.559 11.0504 103.334 8.74023 100.66 8.74023ZM100.66 17.1178C99.1378 17.1178 97.887 15.8069 97.887 13.9271C97.887 12.0473 99.1353 10.7363 100.66 10.7363C102.185 10.7363 103.433 12.0473 103.433 13.9271C103.433 15.8069 102.185 17.1178 100.66 17.1178Z" fill="var(--light-contrastText)"></path><path d="M109.696 6.43005H107.841V7.9166C107.841 8.6809 107.432 9.0915 106.65 9.0915H105.947V10.912H107.567V15.6684C107.567 17.8401 108.875 19.114 110.671 19.114C111.199 19.114 111.589 19.015 111.843 18.9186V16.9621C111.648 17.061 111.413 17.0981 111.159 17.0981C110.281 17.0981 109.694 16.5886 109.694 15.4928V10.912H111.84V8.97525H109.694V6.43005H109.696Z" fill="var(--light-contrastText)"></path><path d="M58.6421 10.7363C60.0483 10.7363 60.8279 11.8123 61.0622 12.6161H63.2085C62.8187 10.6794 61.0992 8.74023 58.6397 8.74023C55.9655 8.74023 53.7402 11.0307 53.7402 13.9271C53.7402 16.8235 55.9655 19.1139 58.6397 19.1139C61.0992 19.1139 62.8187 17.1574 63.2085 15.238H61.0622C60.8279 16.0394 60.0458 17.1178 58.6421 17.1178C57.12 17.1178 55.8692 15.8069 55.8692 13.9271C55.8692 12.0473 57.1175 10.7363 58.6421 10.7363Z" fill="var(--light-contrastText)"></path><path d="M66.7906 5.17847H64.6418V18.8814H66.7906V5.17847Z" fill="var(--light-contrastText)"></path><path d="M39.8611 6.43005H38.006V7.9166C38.006 8.6809 37.5965 9.0915 36.8144 9.0915H36.1113V10.912H37.7321V15.6684C37.7321 17.8401 39.0396 19.114 40.8356 19.114C41.3635 19.114 41.7533 19.015 42.0074 18.9186V16.9621C41.8125 17.061 41.5782 17.0981 41.3241 17.0981C40.4458 17.0981 39.8611 16.5886 39.8611 15.4928V10.912H42.0074V8.97525H39.8611V6.43005Z" fill="var(--light-contrastText)"></path><path d="M50.59 9.92502C50.5702 10.2342 50.173 10.3455 49.9979 10.0883C49.5489 9.42786 48.72 8.74023 47.2151 8.74023C44.7753 8.74023 42.666 10.9119 42.666 13.9271C42.666 16.9422 44.7753 19.1139 47.2151 19.1139C48.6978 19.1139 49.5366 18.3843 49.993 17.709C50.1656 17.4542 50.5653 17.5705 50.585 17.8772L50.6492 18.879H52.3144V8.97521H50.6492L50.5875 9.92502H50.59ZM47.452 17.1178C46.026 17.1178 44.7975 15.8267 44.7975 13.9271C44.7975 12.0275 46.0285 10.7363 47.452 10.7363C48.8754 10.7363 50.1064 12.0275 50.1064 13.9271C50.1064 15.8267 48.8754 17.1178 47.452 17.1178Z" fill="var(--light-contrastText)"></path><path d="M28.1527 8.8194C28.1527 7.78302 28.952 6.99893 30.4174 6.99893C31.7965 6.99893 32.6772 7.85722 32.8203 9.09395H35.085C34.8925 6.75158 33.1385 4.94348 30.415 4.94348C27.6914 4.94348 25.8856 6.60812 25.8856 8.77982C25.8856 13.6525 33.03 12.2254 33.03 15.2578C33.03 16.2571 32.2307 17.0585 30.5901 17.0585C28.9496 17.0585 27.9751 16.079 27.837 14.6716H25.5723C25.6882 17.2366 27.5434 19.1139 30.5704 19.1139C33.5974 19.1139 35.2946 17.4295 35.2946 15.1985C35.2946 10.2664 28.1503 11.7925 28.1503 8.81692L28.1527 8.8194Z" fill="var(--light-contrastText)"></path><path d="M133.017 6.66505V5.17603H127.616V6.66505H129.417V17.3925H127.616V18.8815H133.017V17.3925H131.216V6.66505H133.017Z" fill="#FF6900"></path><path d="M119.505 5.17603L114.349 18.8864H116.185L120.327 7.60496L124.466 18.8864H126.381L121.225 5.17603H119.505Z" fill="#FF6900"></path><path d="M120.265 16.4821C120.837 16.4821 121.301 16.017 121.301 15.4433C121.301 14.8695 120.837 14.4044 120.265 14.4044C119.693 14.4044 119.229 14.8695 119.229 15.4433C119.229 16.017 119.693 16.4821 120.265 16.4821Z" fill="#FF6900"></path><path d="M19.0521 8.60424C19.9969 8.60424 20.7617 7.83746 20.7617 6.89013C20.7617 5.94279 19.9969 5.17602 19.0521 5.17602C18.1072 5.17602 17.3425 5.94279 17.3425 6.89013C17.3425 7.83746 18.1072 8.60424 19.0521 8.60424ZM19.0521 15.4607C18.1072 15.4607 17.3425 16.2274 17.3425 17.1748C17.3425 18.1221 18.1072 18.8889 19.0521 18.8889C19.9969 18.8889 20.7617 18.1221 20.7617 17.1748C20.7617 16.2274 19.9969 15.4607 19.0521 15.4607ZM10.388 20.6055C9.44319 20.6055 8.67842 21.3722 8.67842 22.3196C8.67842 23.2669 9.44319 24.0337 10.388 24.0337C11.3329 24.0337 12.0977 23.2669 12.0977 22.3196C12.0977 21.3722 11.3329 20.6055 10.388 20.6055ZM18.4526 13.6377C19.1064 13.8826 19.8761 13.7119 20.3621 13.1381C20.9418 12.448 20.8777 11.3943 20.219 10.7784C19.733 10.3258 19.057 10.2095 18.4723 10.4222C18.0332 10.5805 17.5497 10.5434 17.1476 10.306C16.743 10.0661 16.4815 9.65051 16.4075 9.1855C16.3335 8.7378 16.0843 8.31979 15.6797 8.04523C15.2135 7.72863 14.6485 7.67421 14.1551 7.84983C13.7111 8.00566 13.2226 7.97845 12.8156 7.73852C12.4085 7.4986 12.1495 7.08058 12.073 6.6131C11.9965 6.15551 11.7375 5.73007 11.3181 5.45552C10.5731 4.97072 9.55174 5.15376 9.02133 5.86611C8.43173 6.65515 8.62662 7.76821 9.43085 8.31484C9.89711 8.63144 10.4621 8.68586 10.9555 8.51025C11.3995 8.35442 11.888 8.38163 12.295 8.62155C12.6996 8.86148 12.9611 9.27702 13.0376 9.7445C13.1116 10.1922 13.3608 10.6102 13.7653 10.8848C14.2316 11.2014 14.7965 11.2558 15.2899 11.0802C15.322 11.0678 15.8105 10.8427 16.0596 10.8427C16.7159 10.8427 17.2487 11.377 17.2487 12.0349C17.2487 12.6929 16.7159 13.2271 16.0596 13.2271C15.8105 13.2271 15.3245 12.9996 15.2924 12.9897C14.8064 12.8165 14.2513 12.866 13.7875 13.1702C13.3682 13.4448 13.1141 13.8727 13.0401 14.3328C12.9636 14.7953 12.7045 15.2109 12.2975 15.4533C11.8929 15.6932 11.4044 15.7229 10.9579 15.5646C10.4645 15.3914 9.89958 15.4458 9.43332 15.76C8.62908 16.3066 8.43419 17.4197 9.0238 18.2087C9.55667 18.921 10.5755 19.1041 11.3206 18.6193C11.7424 18.3447 12.0015 17.9193 12.0755 17.4617C12.1519 16.9942 12.411 16.5787 12.818 16.3363C13.2226 16.0964 13.827 16.1409 14.1527 16.22C14.6535 16.3412 15.1937 16.3437 15.6575 16.0395C16.0769 15.7649 16.3335 15.337 16.4075 14.8769C16.4815 14.4144 16.743 14.0013 17.1476 13.7614C17.5423 13.5264 18.0234 13.4745 18.4526 13.6377ZM9.79103 13.6377C10.4448 13.8826 11.2145 13.7119 11.7005 13.1381C12.2802 12.448 12.2161 11.3943 11.5574 10.7784C11.0714 10.3258 10.3954 10.2095 9.81077 10.4222C9.37165 10.5805 8.88812 10.5434 8.486 10.306C8.08142 10.0661 7.81991 9.65051 7.7459 9.1855C7.74344 9.16324 7.4474 7.75337 6.05849 7.75337C5.11363 7.75337 4.34887 8.52014 4.34887 9.46747C4.34887 10.4148 5.11363 11.1816 6.05849 11.1816C6.33972 11.1816 6.60369 11.1123 6.83805 10.9911C7.01074 10.9243 7.24511 10.8427 7.39559 10.8427C8.05181 10.8427 8.58468 11.377 8.58468 12.0349C8.58468 12.6929 8.05181 13.2271 7.39559 13.2271C7.23031 13.2271 6.96387 13.1282 6.79118 13.0589C6.73444 13.0367 6.35206 12.8907 6.05602 12.8907C5.11117 12.8907 4.3464 13.6575 4.3464 14.6049C4.3464 15.5522 5.11117 16.319 6.05602 16.319C6.89973 16.319 7.60035 15.7055 7.7385 14.8967C7.7385 14.8893 7.74344 14.8819 7.7459 14.8745C7.81991 14.4119 8.08142 13.9989 8.486 13.7589C8.88072 13.524 9.36178 13.472 9.79103 13.6353V13.6377ZM14.7201 18.0331C13.7752 18.0331 13.0104 18.7998 13.0104 19.7472C13.0104 20.6945 13.7752 21.4613 14.7201 21.4613C15.6649 21.4613 16.4297 20.6945 16.4297 19.7472C16.4297 18.7998 15.6649 18.0331 14.7201 18.0331ZM10.388 3.46191C11.3329 3.46191 12.0977 2.69514 12.0977 1.7478C12.0977 0.800465 11.3329 0.0336914 10.388 0.0336914C9.44319 0.0336914 8.67842 0.800465 8.67842 1.7478C8.67842 2.69514 9.44319 3.46191 10.388 3.46191ZM6.05849 18.0331C5.11363 18.0331 4.34887 18.7998 4.34887 19.7472C4.34887 20.6945 5.11363 21.4613 6.05849 21.4613C7.00334 21.4613 7.76811 20.6945 7.76811 19.7472C7.76811 18.7998 7.00334 18.0331 6.05849 18.0331ZM14.7201 6.03431C15.6649 6.03431 16.4297 5.26754 16.4297 4.3202C16.4297 3.37286 15.6649 2.60609 14.7201 2.60609C13.7752 2.60609 13.0104 3.37286 13.0104 4.3202C13.0104 5.26754 13.7752 6.03431 14.7201 6.03431ZM6.05849 6.03431C7.00334 6.03431 7.76811 5.26754 7.76811 4.3202C7.76811 3.37286 7.00334 2.60609 6.05849 2.60609C5.11363 2.60609 4.34887 3.37286 4.34887 4.3202C4.34887 5.26754 5.11363 6.03431 6.05849 6.03431ZM1.72647 5.17602C0.78161 5.17602 0.0168457 5.94279 0.0168457 6.89013C0.0168457 7.83746 0.78161 8.60424 1.72647 8.60424C2.67132 8.60424 3.43608 7.83746 3.43608 6.89013C3.43608 5.94279 2.67132 5.17602 1.72647 5.17602ZM1.72647 15.4607C0.78161 15.4607 0.0168457 16.2274 0.0168457 17.1748C0.0168457 18.1221 0.78161 18.8889 1.72647 18.8889C2.67132 18.8889 3.43608 18.1221 3.43608 17.1748C3.43608 16.2274 2.67132 15.4607 1.72647 15.4607ZM1.72647 10.3183C0.78161 10.3183 0.0168457 11.0851 0.0168457 12.0325C0.0168457 12.9798 0.78161 13.7466 1.72647 13.7466C2.67132 13.7466 3.43608 12.9798 3.43608 12.0325C3.43608 11.0851 2.67132 10.3183 1.72647 10.3183Z" fill="#FF6900"></path></g><defs><clipPath id="clip0_7262_63725"><rect width="133" height="24" fill="white" transform="translate(0.0168457 0.0336914)"></rect></clipPath></defs></svg>
        <span class="app-title">AutoUnitTest</span>
      </div>
      <span class="spacer"></span>
      <mat-chip-listbox>
        <mat-chip [color]="isConnected() ? 'accent' : 'warn'">
          {{ isConnected() ? 'Conectado' : 'Desconectado' }}
        </mat-chip>
      </mat-chip-listbox>
    </mat-toolbar-row>
  </mat-toolbar>

  <!-- Status Messages -->
  <div class="status-section">
    <mat-card *ngIf="errorMessage()" class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon color="warn">error</mat-icon>
          <span>{{ errorMessage() }}</span>
          <button mat-icon-button (click)="clearError()" class="clear-error">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <mat-horizontal-stepper [linear]="true" class="flow-stepper" [disableRipple]="true">

    
    <mat-step label="1. Escanear" [completed]="!!scanProgress() || scannedComponents().length > 0">
    <!-- Step 1: Directory Scan -->
    <mat-card class="step-card">
      <mat-card-header>
        <mat-card-title>
          <span class="step-number">1</span>
          <mat-icon>folder</mat-icon>
          Escanear Diret√≥rio
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="input-group">
          <mat-form-field appearance="outline" class="directory-input">
            <mat-label>Caminho do diret√≥rio</mat-label>
            <input 
              matInput
              [(ngModel)]="directoryPath" 
              placeholder="ex: C:\Users\...\src"
              [disabled]="isScanning()"
            >
          </mat-form-field>
          <button 
            mat-raised-button 
            color="primary"
            (click)="scanDirectory()" 
            [disabled]="isScanning() || !directoryPath().trim()"
            class="scan-button"
          >
            <mat-icon>{{ isScanning() ? 'refresh' : 'search' }}</mat-icon>
            {{ isScanning() ? 'Escaneando...' : 'Escanear' }}
          </button>
        </div>
        
        <!-- Scan Progress -->
        <div class="progress-section" *ngIf="scanProgress()">
          <mat-progress-bar 
            mode="determinate" 
            [value]="scanProgress()!.percentage"
            color="primary"
          ></mat-progress-bar>
          <div class="progress-text">
            {{ scanProgress()!.current }}/{{ scanProgress()!.total }} - {{ scanProgress()!.currentFile }}
          </div>
        </div>
      </mat-card-content>
    </mat-card>
    </mat-step>

    <mat-step label="2. Selecionar" [completed]="selectedFiles().length > 0">
    <!-- Step 2: Select Components -->
    <mat-expansion-panel *ngIf="scannedComponents().length > 0">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">2</span>
          <mat-icon>description</mat-icon>
          Selecionar Componentes ({{ scannedComponents().length }} encontrados)
        </mat-panel-title>
        <mat-panel-description>
          <div class="step-actions">
            <button mat-raised-button (click)="selectAllFiles()" color="primary">
              <mat-icon>select_all</mat-icon>
              Todos
            </button>
            <button mat-raised-button (click)="clearSelection()" color="accent">
              <mat-icon>clear_all</mat-icon>
              Limpar
            </button>
          </div>
        </mat-panel-description>
      </mat-expansion-panel-header>

        <div class="selection-info">
          <mat-chip color="primary">
            <mat-icon>check_circle</mat-icon>
            {{ selectedFiles().length }} selecionados
          </mat-chip>
        </div>
        
        <mat-table [dataSource]="scannedComponents()" class="components-table">
          <!-- Checkbox Column -->
          <ng-container matColumnDef="select">
            <mat-header-cell *matHeaderCellDef>
              <mat-checkbox 
                [checked]="selectedFiles().length === scannedComponents().length && scannedComponents().length > 0"
                [indeterminate]="selectedFiles().length > 0 && selectedFiles().length < scannedComponents().length"
                (change)="toggleAllFiles()"
              ></mat-checkbox>
            </mat-header-cell>
            <mat-cell *matCellDef="let component">
              <mat-checkbox 
                [checked]="selectedFiles().includes(component.filePath)"
                (change)="toggleFileSelection(component.filePath)"
              ></mat-checkbox>
            </mat-cell>
          </ng-container>

          <!-- Component Name Column -->
          <ng-container matColumnDef="component">
            <mat-header-cell *matHeaderCellDef>Componente</mat-header-cell>
            <mat-cell *matCellDef="let component">
              <strong>{{ component.name }}</strong>
            </mat-cell>
          </ng-container>

          <!-- File Path Column -->
          <ng-container matColumnDef="file">
            <mat-header-cell *matHeaderCellDef>Arquivo</mat-header-cell>
            <mat-cell *matCellDef="let component">
              <span class="path-text">{{ component.filePath }}</span>
            </mat-cell>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <mat-header-cell *matHeaderCellDef>Tipo</mat-header-cell>
            <mat-cell *matCellDef="let component">
              <mat-chip [color]="component.isStandalone ? 'accent' : 'primary'">
                {{ component.isStandalone ? 'Standalone' : 'Regular' }}
              </mat-chip>
            </mat-cell>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <mat-header-cell *matHeaderCellDef>A√ß√µes</mat-header-cell>
            <mat-cell *matCellDef="let component">
              <button 
                mat-icon-button
                (click)="viewFileContent(component)" 
                title="Ver c√≥digo"
                color="primary"
              >
                <mat-icon>visibility</mat-icon>
              </button>
              <button 
                mat-icon-button
                (click)="generateTestForComponent(component)"
                [disabled]="isCreatingTest()"
                title="Gerar teste"
                color="accent"
              >
                <mat-icon>{{ isCreatingTest() ? 'hourglass_empty' : 'auto_awesome' }}</mat-icon>
              </button>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="['select', 'component', 'file', 'type', 'actions']"></mat-header-row>
          <mat-row 
            *matRowDef="let row; columns: ['select', 'component', 'file', 'type', 'actions'];"
            [class.selected]="selectedFiles().includes(row.filePath)"
          ></mat-row>
        </mat-table>
    </mat-expansion-panel>
    </mat-step>

    <mat-step label="3. Gerar" [completed]="!!testProgress() || testResults().length > 0">
    <!-- Step 3: Generate Tests -->
    <mat-card class="step-card" *ngIf="hasSelectedFiles()">
      <mat-card-header>
        <mat-card-title>
          <span class="step-number">3</span>
          <mat-icon>science</mat-icon>
          Gerar Testes Unit√°rios
        </mat-card-title>
        <button 
          mat-raised-button
          color="primary"
          (click)="generateTests()" 
          [disabled]="!canGenerateTests()"
          class="generate-tests-btn"
        >
          <mat-icon>{{ isGeneratingTests() ? 'refresh' : 'rocket_launch' }}</mat-icon>
          {{ isGeneratingTests() ? 'Gerando...' : 'Gerar Testes' }}
        </button>
      </mat-card-header>

      <!-- Test Generation Progress -->
      <mat-card-content *ngIf="testProgress()">
        <div class="progress-section">
          <mat-progress-bar 
            mode="determinate" 
            [value]="testProgress()!.percentage"
            color="primary"
          ></mat-progress-bar>
          <div class="progress-text">
            {{ testProgress()!.current }}/{{ testProgress()!.total }} - {{ testProgress()!.currentFile }}
          </div>
        </div>
      </mat-card-content>
    </mat-card>
    <div class="no-data" *ngIf="!hasSelectedFiles()">Selecione ao menos um arquivo para gerar testes.</div>
    </mat-step>

    <mat-step label="4. Resultados" [completed]="testResults().length > 0">
    <!-- Step 4: Test Results -->
    <mat-expansion-panel *ngIf="testResults().length > 0">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">4</span>
          <mat-icon>assessment</mat-icon>
          Resultados dos Testes ({{ testResults().length }})
        </mat-panel-title>
        <mat-panel-description>
          <div class="results-summary">
            <mat-chip color="primary">
              <mat-icon>check_circle</mat-icon>
              {{ successCount() }} Sucessos
            </mat-chip>
            <mat-chip color="warn" *ngIf="errorCount() > 0">
              <mat-icon>error</mat-icon>
              {{ errorCount() }} Erros
            </mat-chip>
          </div>
        </mat-panel-description>
      </mat-expansion-panel-header>

        <mat-table [dataSource]="testResults()" class="test-results-table">
          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <mat-header-cell *matHeaderCellDef>Status</mat-header-cell>
            <mat-cell *matCellDef="let result">
              <mat-chip [color]="result.success ? 'primary' : 'warn'">
                <mat-icon>{{ result.success ? 'check_circle' : 'error' }}</mat-icon>
                {{ result.success ? 'Sucesso' : 'Erro' }}
              </mat-chip>
            </mat-cell>
          </ng-container>

          <!-- File Column -->
          <ng-container matColumnDef="file">
            <mat-header-cell *matHeaderCellDef>Arquivo</mat-header-cell>
            <mat-cell *matCellDef="let result">
              <div class="file-info">
                <div class="file-name">{{ getFileName(result.filePath) }}</div>
                <div class="file-path">{{ result.filePath }}</div>
              </div>
            </mat-cell>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <mat-header-cell *matHeaderCellDef>A√ß√µes</mat-header-cell>
            <mat-cell *matCellDef="let result">
              <div class="action-buttons">
                <button 
                  mat-icon-button
                  (click)="copyTestCode(result.testCode)"
                  title="Copiar c√≥digo"
                  *ngIf="result.success"
                  color="primary"
                >
                  <mat-icon>content_copy</mat-icon>
                </button>
                <button 
                  mat-icon-button
                  (click)="createTestFile(result)"
                  [disabled]="isCreatingTest()"
                  title="Criar arquivo"
                  *ngIf="result.success"
                  color="accent"
                >
                  <mat-icon>{{ isCreatingTest() ? 'hourglass_empty' : 'save' }}</mat-icon>
                </button>
                <button 
                  mat-icon-button
                  (click)="executeTest(result)"
                  [disabled]="isExecutingTest() || !result.success"
                  title="Executar teste"
                  *ngIf="result.success"
                  color="primary"
                >
                  <mat-icon>{{ isExecutingTest() ? 'hourglass_empty' : 'play_arrow' }}</mat-icon>
                </button>
                <button 
                  mat-icon-button
                  (click)="retryTest(result)"
                  [disabled]="isGeneratingTests()"
                  title="Refazer teste"
                  *ngIf="!result.success"
                  color="warn"
                >
                  <mat-icon>{{ isGeneratingTests() ? 'hourglass_empty' : 'refresh' }}</mat-icon>
                </button>
                <button 
                  mat-icon-button
                  (click)="viewTestDetails(result)"
                  title="Ver detalhes"
                  color="primary"
                >
                  <mat-icon>visibility</mat-icon>
                </button>
              </div>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="['status', 'file', 'actions']"></mat-header-row>
          <mat-row *matRowDef="let row; columns: ['status', 'file', 'actions'];"></mat-row>
        </mat-table>
    </mat-expansion-panel>
    <div class="no-data" *ngIf="testResults().length === 0">Gere testes para visualizar os resultados.</div>
    </mat-step>

    <mat-step label="5. Executar" [completed]="allTestsExecution() && allTestsExecution()!.status !== 'running'">
    <!-- Step 5: Execute All Tests -->
    <mat-expansion-panel *ngIf="hasCreatedTests()">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <span class="step-number">5</span>
          <mat-icon>play_arrow</mat-icon>
          Executar Todos os Testes
        </mat-panel-title>
        <mat-panel-description>
          <button 
            mat-raised-button
            color="accent"
            (click)="executeAllTests()" 
            [disabled]="isExecutingAllTests()"
            class="execute-all-tests-btn"
          >
            <mat-icon>{{ isExecutingAllTests() ? 'hourglass_empty' : 'play_arrow' }}</mat-icon>
            {{ isExecutingAllTests() ? 'Executando...' : 'Executar Todos' }}
          </button>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <!-- All Tests Execution Progress -->
      <div class="all-tests-execution" *ngIf="allTestsExecution()">
        <div class="execution-status">
          <span class="status-badge" [class]="getAllTestsExecutionStatusClass(allTestsExecution()!.status)">
            {{ getAllTestsExecutionStatusText(allTestsExecution()!.status) }}
          </span>
        </div>
        <div class="execution-output">
          <pre class="output-content">{{ allTestsExecution()!.output }}</pre>
        </div>
      </div>
    </mat-expansion-panel>
    <div class="no-data" *ngIf="!hasCreatedTests()">Gere ao menos um teste antes de executar todos.</div>
    </mat-step>

    </mat-horizontal-stepper>
  </div>

  <!-- Modals -->
  <!-- File Content Modal -->
  <div class="file-content-modal" *ngIf="fileContent()" (click)="closeFileContentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <mat-icon>code</mat-icon>
          C√≥digo do Arquivo: {{ getFileName(currentFilePath()) }}
        </h3>
        <button mat-icon-button (click)="closeFileContentModal()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="file-info-header">
          <mat-chip color="accent">
            <mat-icon>description</mat-icon>
            {{ currentFilePath() }}
          </mat-chip>
        </div>
        <div class="code-container">
          <pre><code>{{ fileContent() }}</code></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Details Modal -->
  <div class="test-details-modal" *ngIf="selectedTestResult()" (click)="closeTestDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalhes do Teste: {{ getFileName(selectedTestResult()!.filePath) }}</h3>
        <button mat-icon-button (click)="closeTestDetails()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="test-details-content" *ngIf="selectedTestResult()!.success">
          <div class="explanation">
            <h4>üìù Explica√ß√£o:</h4>
            <p>{{ selectedTestResult()!.explanation }}</p>
          </div>

          <div class="test-cases" *ngIf="selectedTestResult()!.testCases.length > 0">
            <h4>üß™ Casos de Teste:</h4>
            <ul>
              <li *ngFor="let testCase of selectedTestResult()!.testCases">{{ testCase }}</li>
            </ul>
          </div>

          <div class="dependencies" *ngIf="selectedTestResult()!.dependencies.length > 0">
            <h4>üì¶ Depend√™ncias:</h4>
            <ul>
              <li *ngFor="let dep of selectedTestResult()!.dependencies">{{ dep }}</li>
            </ul>
          </div>

          <div class="test-code">
            <div class="test-code-header">
              <h4>üíª C√≥digo do Teste:</h4>
              <div class="test-code-actions">
                <button 
                  mat-raised-button
                  color="primary"
                  (click)="copyTestCode(selectedTestResult()!.testCode)"
                  title="Copiar c√≥digo"
                >
                  <mat-icon>content_copy</mat-icon>
                  Copiar
                </button>
                <button 
                  mat-raised-button
                  color="accent"
                  (click)="createTestFile(selectedTestResult()!)"
                  [disabled]="isCreatingTest()"
                  title="Criar arquivo de teste no projeto"
                >
                  <mat-icon>{{ isCreatingTest() ? 'hourglass_empty' : 'save' }}</mat-icon>
                  {{ isCreatingTest() ? 'Criando...' : 'Criar Teste' }}
                </button>
                <button 
                  mat-raised-button
                  color="primary"
                  (click)="executeTest(selectedTestResult()!)"
                  [disabled]="isExecutingTest() || !selectedTestResult()!.success"
                  title="Executar teste com Jest"
                >
                  <mat-icon>{{ isExecutingTest() ? 'hourglass_empty' : 'play_arrow' }}</mat-icon>
                  {{ isExecutingTest() ? 'Executando...' : 'Executar Teste' }}
                </button>
              </div>
            </div>
            <div class="code-container">
              <pre><code class="typescript">{{ formatTestCode(selectedTestResult()!.testCode) }}</code></pre>
            </div>
            
            <!-- Test Execution Section -->
            <div class="test-execution" *ngIf="selectedTestResult()!.testExecution">
              <div class="test-execution-header">
                <h4>üß™ Execu√ß√£o do Teste:</h4>
                <div class="execution-status">
                  <button 
                    *ngIf="selectedTestResult()!.testExecution!.status === 'error'"
                    mat-raised-button
                    color="warn"
                    (click)="regenerateTestFromExecutionError(selectedTestResult()!)"
                    [disabled]="isFixingTest() || fixingTestFile() === selectedTestResult()!.filePath"
                    title="Gerar novo teste corrigindo o erro de execu√ß√£o"
                    class="regenerate-button"
                  >
                    <mat-icon>{{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'hourglass_empty' : 'autorenew' }}</mat-icon>
                    {{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'Corrigindo...' : 'Corrigir com IA' }}
                  </button>
                  <span class="status-badge" [class]="getExecutionStatusClass(selectedTestResult()!.testExecution!.status)">
                    {{ getExecutionStatusText(selectedTestResult()!.testExecution!.status) }}
                  </span>
                </div>
              </div>
              <div class="execution-output">
                <pre class="output-content">{{ selectedTestResult()!.testExecution!.output }}</pre>
              </div>
            </div>
          </div>
        </div>

        <div class="result-error" *ngIf="!selectedTestResult()!.success">
          <div class="error-content">
            <div class="error-header">
              <mat-icon color="warn">error</mat-icon>
              <h4>Detalhes do Erro</h4>
            </div>
            <div class="error-message-box">
              <div class="error-label">Arquivo:</div>
              <div class="error-value">{{ selectedTestResult()!.filePath }}</div>
            </div>
            <div class="error-message-box" *ngIf="selectedTestResult()!.timestamp">
              <div class="error-label">Data/Hora:</div>
              <div class="error-value">{{ selectedTestResult()!.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}</div>
            </div>
            <div class="error-message-box">
              <div class="error-label">Mensagem de Erro:</div>
              <div class="error-text">{{ formatErrorMessage(selectedTestResult()!.error) }}</div>
            </div>
            <div class="error-actions">
              <button 
                mat-raised-button
                color="warn"
                (click)="retryTest(selectedTestResult()!)"
                [disabled]="isGeneratingTests()"
                title="Refazer teste"
              >
                <mat-icon>{{ isGeneratingTests() ? 'hourglass_empty' : 'refresh' }}</mat-icon>
                {{ isGeneratingTests() ? 'Refazendo...' : 'Refazer Teste' }}
              </button>
              <button 
                mat-raised-button
                color="accent"
                (click)="fixTestError(selectedTestResult()!)"
                [disabled]="isFixingTest() || fixingTestFile() === selectedTestResult()!.filePath"
                title="Melhorar teste com IA"
              >
                <mat-icon>{{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'hourglass_empty' : 'build' }}</mat-icon>
                {{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'Melhorando...' : 'Melhorar com IA' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Prompt Modal -->
  <div class="custom-prompt-modal" *ngIf="showCustomPromptDialog()" (click)="closeCustomPromptDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üîß Melhorar Teste com IA</h3>
        <button mat-icon-button (click)="closeCustomPromptDialog()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="test-info" *ngIf="selectedTestForPrompt()">
          <div class="test-header">
            <h4>{{ getFileName(selectedTestForPrompt()!.filePath) }}</h4>
            <span class="test-status" [class]="selectedTestForPrompt()!.success ? 'success' : 'error'">
              {{ selectedTestForPrompt()!.success ? '‚úÖ Sucesso' : '‚ùå Erro' }}
            </span>
          </div>
          
          <div class="error-section" *ngIf="!selectedTestForPrompt()!.success">
            <h5>üêõ Erro Encontrado:</h5>
            <div class="error-message">
              {{ selectedTestForPrompt()!.error }}
            </div>
          </div>

          <div class="test-code-preview">
            <h5>üìù C√≥digo do Teste Atual:</h5>
            <div class="code-preview">
              <pre><code class="typescript">{{ selectedTestForPrompt()!.testCode }}</code></pre>
            </div>
          </div>
        </div>

        <div class="prompt-section">
          <h5>üí¨ Instru√ß√µes para a IA:</h5>
          <p class="prompt-description">
            Descreva o que voc√™ gostaria que a IA fa√ßa com este teste. Seja espec√≠fico sobre as melhorias desejadas.
          </p>
          <textarea 
            [(ngModel)]="customPrompt"
            class="prompt-textarea"
            placeholder="Ex: Adicione mais casos de teste para edge cases, melhore a cobertura de c√≥digo, corrija os mocks, etc..."
            rows="6"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button 
            mat-raised-button
            color="warn"
            (click)="closeCustomPromptDialog()"
          >
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
          <button 
            mat-raised-button
            color="primary"
            (click)="processCustomPrompt()"
            [disabled]="!customPrompt().trim() || isFixingTest()"
          >
            <mat-icon>{{ isFixingTest() ? 'hourglass_empty' : 'rocket_launch' }}</mat-icon>
            {{ isFixingTest() ? 'Processando...' : 'Processar com IA' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>