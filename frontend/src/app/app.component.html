<div class="app-container">
  @if (showSplash()) {
    <app-splash (complete)="showSplash.set(false)"></app-splash>
  }

  <!-- Header extraído -->
  <app-header
    [connected]="isConnected()"
    [isExecutingAll]="!directoryPath().trim() || isExecutingAllTests()"
    [autoFlowRunning]="autoFlowRunning()"
    [hasSelection]="selectedFiles().length > 0"
    [isGeneratingTests]="isGeneratingTests()"
    (openProject)="openProjectFromMenu()"
    (runAllTests)="runAllTestsFromMenu()"
    (openOrRunAutoFlow)="openOrRunAiAutoFlow()"
    (toggleAiChat)="toggleAiChat()"
    (openConfig)="openConfigModal()"
  ></app-header>

  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Layout com Angular Material Sidenav -->
    @if (scannedComponents().length > 0) {
    <mat-sidenav-container class="app-sidenav-container">
      <mat-sidenav class="app-sidenav" mode="side" opened>
        <mat-card class="tree-card">
          <mat-card-content>
            <app-sidenav-actions
              [selectionMode]="selectionMode()"
              [hasComponents]="scannedComponents().length > 0"
              [isGenerating]="isGeneratingTests()"
              [selectedCount]="selectedFiles().length"
              (toggleSelectionMode)="toggleSelectionMode()"
              (selectAll)="selectAllFiles()"
              (clearSelection)="clearSelection()"
              (generate)="generateTests()"
            ></app-sidenav-actions>
            <app-project-tree
              [dataSource]="treeDataSource"
              [treeControl]="treeControl"
              [selectionMode]="selectionMode()"
              [selectedFiles]="selectedFiles()"
              [previewPath]="previewPath() || null"
              [newSpecHighlights]="newSpecHighlights()"
              (toggleSelection)="toggleFileSelection($event)"
              (openNode)="toggleInlineFile($event)"
            ></app-project-tree>
            
            
          </mat-card-content>
        </mat-card>
      </mat-sidenav>

      <mat-sidenav-content class="app-sidenav-content">
        <div class="code-log-grid" [ngClass]="{ 'three-cols': isSpecPath(previewPath() || '') , 'two-cols': !isSpecPath(previewPath() || '') }"
             [style.gridTemplateColumns]="isSpecPath(previewPath() || '') ? ('1fr 6px 1fr') : ('1fr')">
          <div class="col code">
            <app-code-viewer
              [path]="previewPath() || null"
              [isSpec]="isSpecPath(previewPath() || '')"
              [content]="previewPath() ? getInlineContent(previewPath()!) : ''"
              [busy]="isCreatingTest() || isGeneratingTests() || isExecutingTest()"
              [codeRenderKey]="codeRenderKey()"
              (executeSpec)="executeCurrentSpec()"
              (generateTest)="generateCurrentTest()"
            ></app-code-viewer>
          </div>
          @if (isSpecPath(previewPath() || '')) {
            <div class="v-resizer" (mousedown)="startResize('code-log', $event)"></div>
            <div class="col log">
              <app-spec-execution-log
                [status]="specExecutions()[directoryPath() + '/' + previewPath()]?.status || 'running'"
                [output]="specExecutions()[directoryPath() + '/' + previewPath()]?.output || ''"
                [isFixing]="isFixingTest()"
                [filePath]="directoryPath() + '/' + (previewPath() || '')"
                (fixFromLog)="fixCurrentSpecFromLog()"
              ></app-spec-execution-log>
            </div>
          }
        </div>
      </mat-sidenav-content>

      <!-- AI Chat Sidenav (direita) - componente apartado -->
      <mat-sidenav class="ai-chat-sidenav" position="end" mode="side" [opened]="showAiChat()">
        <app-ai-chat (close)="toggleAiChat()" [directoryPath]="directoryPath()"></app-ai-chat>
      </mat-sidenav>
    </mat-sidenav-container>
    }

  </div>
 
   <!-- Modals -->
 
  @if (selectedTestResult()) {
    <app-test-details-modal
      [result]="selectedTestResult()!"
      [isCreating]="isCreatingTest()"
      [isExecuting]="isExecutingTest()"
      [isFixing]="isFixingTest()"
      [fixingFile]="fixingTestFile()"
      (close)="closeTestDetails()"
      (copy)="copyTestCode($event)"
      (createFile)="createTestFile($event)"
      (execute)="executeTest($event)"
      (regenerateFromError)="regenerateTestFromExecutionError($event)"
    ></app-test-details-modal>
  }

  @if (showCustomPromptDialog()) {
    <app-custom-prompt-modal
      [value]="customPrompt()"
      [busy]="isFixingTest()"
      (valueChange)="customPrompt.set($event)"
      (cancel)="closeCustomPromptDialog()"
      (submit)="processCustomPrompt()"
    ></app-custom-prompt-modal>
  }

  <!-- Configuration Modal -->
  @if (showConfigModal()) {
  <div class="config-modal" (click)="closeConfigModal()">
    <div class="modal-content config-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <mat-icon>settings</mat-icon>
          Configuração do Sistema
        </h3>
        <button mat-icon-button (click)="closeConfigModal()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <mat-tab-group>
          <!-- Tab 1: Configurações Gerais -->
          <mat-tab label="Geral">
            <div class="config-form">
              <mat-form-field appearance="fill">
                <mat-label>Ambiente</mat-label>
                <select matNativeControl [ngModel]="configNodeEnv()" (ngModelChange)="configNodeEnv.set($event)">
                  <option value="development">Development</option>
                  <option value="production">Production</option>
                </select>
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>Porta do Servidor</mat-label>
                <input matInput type="number" [ngModel]="configPort()" (ngModelChange)="configPort.set(+$event)">
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>CORS Origin</mat-label>
                <input matInput [ngModel]="configCorsOrigin()" (ngModelChange)="configCorsOrigin.set($event)">
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>Nível de Log</mat-label>
                <select matNativeControl [ngModel]="configLogLevel()" (ngModelChange)="configLogLevel.set($event)">
                  <option value="debug">Debug</option>
                  <option value="info">Info</option>
                  <option value="warn">Warn</option>
                  <option value="error">Error</option>
                </select>
              </mat-form-field>
            </div>
          </mat-tab>

          <!-- Tab 2: Provedor de IA -->
          <mat-tab label="Provedor de IA">
            <div class="config-form">
              <mat-form-field appearance="fill">
                <mat-label>Provedor</mat-label>
                <select matNativeControl [ngModel]="configAiProvider()" (ngModelChange)="configAiProvider.set($event)">
                  <option value="openai">OpenAI</option>
                  <option value="stackspot">StackSpot</option>
                </select>
              </mat-form-field>

              @if (configAiProvider() === 'openai') {
              <mat-form-field appearance="fill">
                <mat-label>OpenAI API Key</mat-label>
                <input matInput type="password" [ngModel]="configOpenaiKey()" (ngModelChange)="configOpenaiKey.set($event)">
                <mat-hint>Chave da API OpenAI</mat-hint>
              </mat-form-field>
              }

              @if (configAiProvider() === 'stackspot') {
              <div class="stackspot-config">
                <h4>Configurações StackSpot</h4>
                <!-- Alerta informativo com link para criação de conta e agente -->
                <div class="config-info">
                  <mat-icon color="primary">info</mat-icon>
                  <span>
                    <p>Para utilizar o StackSpot, siga estes passos:</p>
                    <p>1) Acesse <a href="https://ai.stackspot.com/" target="_blank" rel="noopener">ai.stackspot.com</a> e crie sua conta.</p>
                    <p>2) Crie um Agente e copie o <strong>Client ID</strong> e o <strong>Client Key</strong>.</p>
                    <p>3) Preencha os campos abaixo. O <em>Realm</em> mais comum é <code>stackspot-freemium</code>.</p>
                  </span>
                </div>

                <mat-form-field appearance="fill">
                  <mat-label>Client ID</mat-label>
                  <input matInput type="password" [ngModel]="configStackspotClientId()" (ngModelChange)="configStackspotClientId.set($event)">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Client Key</mat-label>
                  <input matInput type="password" [ngModel]="configStackspotClientKey()" (ngModelChange)="configStackspotClientKey.set($event)">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Realm</mat-label>
                  <input matInput [ngModel]="configStackspotRealm()" (ngModelChange)="configStackspotRealm.set($event)" placeholder="stackspot-freemium">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Token URL</mat-label>
                  <input matInput [ngModel]="configStackspotTokenUrl()" (ngModelChange)="configStackspotTokenUrl.set($event)">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Completions URL</mat-label>
                  <input matInput [ngModel]="configStackspotCompletionsUrl()" (ngModelChange)="configStackspotCompletionsUrl.set($event)">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Agent Chat URL</mat-label>
                  <input matInput [ngModel]="configStackspotAgentChatUrl()" (ngModelChange)="configStackspotAgentChatUrl.set($event)">
                </mat-form-field>
              </div>
              }
            </div>
          </mat-tab>

          <!-- Tab 3: Avançado -->
          <mat-tab label="Avançado">
            <div class="config-form">
              <mat-form-field appearance="fill">
                <mat-label>Database URL</mat-label>
                <input matInput [ngModel]="configDatabaseUrl()" (ngModelChange)="configDatabaseUrl.set($event)">
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>JWT Secret</mat-label>
                <input matInput type="password" [ngModel]="configJwtSecret()" (ngModelChange)="configJwtSecret.set($event)">
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>User Agent</mat-label>
                <input matInput [ngModel]="configUserAgent()" (ngModelChange)="configUserAgent.set($event)">
              </mat-form-field>
            </div>
          </mat-tab>
        </mat-tab-group>

        <div class="config-info">
          <mat-icon color="primary">info</mat-icon>
          <span>As configurações são aplicadas automaticamente após salvar. Não é necessário reiniciar o servidor.</span>
        </div>

        <!-- Feedback de salvamento -->
        @if (configSaveMessage()) {
          <div class="config-save-feedback">
            <div [class]="configSaveSuccess() ? 'save-success' : 'save-error'">
              <mat-icon>{{ configSaveSuccess() ? 'check_circle' : 'error' }}</mat-icon>
              <span>{{ configSaveMessage() }}</span>
            </div>
          </div>
        }

        <div class="modal-actions">
          <button mat-raised-button color="warn" (click)="closeConfigModal()">
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
          <button mat-raised-button color="primary" (click)="saveConfig()" [disabled]="isSavingConfig()">
            <mat-icon>{{ isSavingConfig() ? 'hourglass_empty' : 'save' }}</mat-icon>
            {{ isSavingConfig() ? 'Salvando...' : 'Salvar Configuração' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  }
  <!-- Footer -->
  <footer class="app-footer">
    <div class="footer-content">
      <span>Desenvolvido por <strong>iago_galdino@hotmail.com</strong></span>
    </div>
  </footer>

  <app-all-tests-modal
    [opened]="showAllTestsModal()"
    [status]="allTestsExecution()?.status || ''"
    [output]="allTestsExecution()?.output || ''"
    (close)="closeAllTestsModal()"
  ></app-all-tests-modal>

  <app-auto-flow-modal
    [opened]="showAutoFlowModal()"
    [paused]="autoFlowPaused()"
    [logHtml]="formatAutoFlowLog(autoFlowLog())"
    (togglePause)="toggleAutoFlowPause()"
    (close)="showAutoFlowModal.set(false)"
  ></app-auto-flow-modal>
</div>