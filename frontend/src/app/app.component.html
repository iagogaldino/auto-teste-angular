<div class="app-container">
  <app-splash *ngIf="showSplash()" (complete)="showSplash.set(false)"></app-splash>

  <!-- Header -->
  <mat-toolbar color="primary" class="app-header">
    <mat-toolbar-row>
      <div class="brand">
        <img src="/assets/logo-stackspot-ai.svg" alt="Logo" class="app-logo" width="139" height="24" />
        <span class="app-title">DelsucTest</span>
      </div>
      <span class="spacer"></span>
      <button mat-icon-button (click)="openConfigModal()" title="Configura√ß√µes" color="primary">
        <mat-icon>settings</mat-icon>
      </button>
      <mat-chip-listbox>
        <mat-chip [color]="isConnected() ? 'accent' : 'warn'">
          {{ isConnected() ? 'Conectado' : 'Desconectado' }}
        </mat-chip>
      </mat-chip-listbox>
    </mat-toolbar-row>
    <mat-toolbar-row class="top-menu-row">
      <div class="top-menu">
        <button mat-raised-button color="primary" (click)="openProjectFromMenu()">
          <mat-icon>folder_open</mat-icon>
          Abrir Projeto
        </button>
        <button mat-raised-button color="accent" (click)="runAllTestsFromMenu()" [disabled]="!directoryPath().trim() || isExecutingAllTests()">
          <mat-icon>{{ isExecutingAllTests() ? 'hourglass_empty' : 'play_arrow' }}</mat-icon>
          Executar Testes
        </button>
        <span class="spacer"></span>
        <button mat-raised-button (click)="toggleSelectionMode()" [color]="selectionMode() ? 'warn' : 'primary'" [disabled]="scannedComponents().length === 0">
          <mat-icon>{{ selectionMode() ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
          {{ selectionMode() ? 'Sair Sele√ß√£o' : 'Selecionar M√∫ltiplos' }}
        </button>
        <mat-chip color="primary" class="selected-chip">
          <mat-icon>check_circle</mat-icon>
          {{ selectedFiles().length }} selecionados
        </mat-chip>
        <div class="nav-actions">
          <button mat-raised-button (click)="selectAllFiles()" color="primary">
            <mat-icon>select_all</mat-icon>
            Todos
          </button>
          <button mat-raised-button (click)="clearSelection()" color="accent">
            <mat-icon>clear_all</mat-icon>
            Limpar
          </button>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="generateTests()" 
            [disabled]="selectedFiles().length === 0 || isGeneratingTests()"
            title="Gerar testes para os selecionados"
          >
            <mat-icon>{{ isGeneratingTests() ? 'refresh' : 'rocket_launch' }}</mat-icon>
            Gerar Selecionados
          </button>
        </div>
      </div>
    </mat-toolbar-row>
  </mat-toolbar>

  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Layout com Angular Material Sidenav -->
    <mat-sidenav-container class="app-sidenav-container" *ngIf="scannedComponents().length > 0">
      <mat-sidenav class="app-sidenav" mode="side" opened>
        <mat-card class="tree-card">
          <mat-card-content>
            <mat-tree [dataSource]="treeDataSource" [treeControl]="treeControl" class="project-tree">
              <!-- N√≥ de diret√≥rio (pasta) -->
              <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild" class="tree-folder-node">
                <div class="tree-folder-content" matTreeNodePadding [matTreeNodePaddingIndent]="8">
                  <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'toggle ' + node.name">
                    <mat-icon>
                      {{ treeControl.isExpanded(node) ? 'folder_open' : 'folder' }}
                    </mat-icon>
                  </button>
                  <span class="folder-name clickable" (click)="treeControl.toggle(node)">{{ node.name }}</span>
                </div>
                <div [class.tree-children]="true" *ngIf="treeControl.isExpanded(node)">
                  <ng-container matTreeNodeOutlet></ng-container>
                </div>
              </mat-nested-tree-node>

              <!-- N√≥ de arquivo -->
              <mat-tree-node *matTreeNodeDef="let node" class="tree-file-node" matTreeNodePadding [matTreeNodePaddingIndent]="1">
                <button mat-icon-button disabled></button>
                <mat-checkbox *ngIf="selectionMode()"
                  [checked]="selectedFiles().includes(node.path)"
                  (change)="toggleFileSelection(node.path)"
                  [disabled]="!node.isFile || isSpecPath(node.path)"
                  title="{{ isSpecPath(node.path) ? 'Arquivos .spec.ts n√£o s√£o selecion√°veis' : 'Selecionar arquivo' }}"
                ></mat-checkbox>
                <mat-icon>{{ isSpecPath(node.path) ? 'assignment_turned_in' : 'description' }}</mat-icon>
                <span class="file-name clickable" (click)="toggleInlineFile(node)" [ngClass]="{ 'is-new-spec': isSpecPath(node.path) && isNewSpec(node.path), 'selected': isPathSelected(node.path) }">
                  {{ node.name }}
                </span>
              </mat-tree-node>
            </mat-tree>
          </mat-card-content>
        </mat-card>
      </mat-sidenav>

      <mat-sidenav-content class="app-sidenav-content">
        <div class="code-log-grid" [ngClass]="{ 'three-cols': isSpecPath(previewPath() || '') , 'two-cols': !isSpecPath(previewPath() || '') }"
             [style.gridTemplateColumns]="isSpecPath(previewPath() || '') ? ('1fr 6px 1fr') : ('1fr')">
          <div class="col code">
            <div class="code-container" *ngIf="previewPath()" [attr.data-key]="previewPath() + ':' + codeRenderKey()">
              <div class="code-actions-overlay">
                <!-- Executar (somente para .spec.ts) -->
                <button *ngIf="isSpecPath(previewPath() || '')"
                        mat-icon-button color="primary" (click)="executeCurrentSpec()"
                        [disabled]="isExecutingTest()" title="Executar teste">
                  <mat-icon>{{ isExecutingTest() ? 'hourglass_empty' : 'play_arrow' }}</mat-icon>
                </button>
                <!-- Gerar teste (somente para .ts n√£o spec) -->
                <button *ngIf="!isSpecPath(previewPath() || '')"
                        mat-icon-button color="accent" (click)="generateCurrentTest()"
                        [disabled]="isCreatingTest()" title="Gerar teste">
                  <mat-icon>auto_awesome</mat-icon>
                </button>
              </div>
              <pre><code class="language-typescript" [attr.data-path]="previewPath()" [attr.data-version]="codeRenderKey()" [textContent]="getInlineContent(previewPath()!)"></code></pre>
            </div>
          </div>
          <div class="v-resizer" *ngIf="isSpecPath(previewPath() || '')" (mousedown)="startResize('code-log', $event)"></div>
          <div class="col log" *ngIf="isSpecPath(previewPath() || '')">
            <div class="execution-output" [ngClass]="getExecutionStatusClass(specExecutions()[directoryPath() + '/' + previewPath()]?.status || 'running')">
              <pre class="output-content">{{ specExecutions()[directoryPath() + '/' + previewPath()]?.output }}</pre>
            </div>
          </div>
        </div>
      </mat-sidenav-content>
    </mat-sidenav-container>

  </div>
 
   <!-- Modals -->
 
   <!-- Test Details Modal -->
  <div class="test-details-modal" *ngIf="selectedTestResult()" (click)="closeTestDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalhes do Teste: {{ getFileName(selectedTestResult()!.filePath) }}</h3>
        <button mat-icon-button (click)="closeTestDetails()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="test-details-content" *ngIf="selectedTestResult()!.success">
          <div class="explanation">
            <h4>üìù Explica√ß√£o:</h4>
            <p>{{ selectedTestResult()!.explanation }}</p>
          </div>

          <div class="test-cases" *ngIf="selectedTestResult()!.testCases.length > 0">
            <h4>üß™ Casos de Teste:</h4>
            <ul>
              <li *ngFor="let testCase of selectedTestResult()!.testCases">{{ testCase }}</li>
            </ul>
          </div>

          <div class="dependencies" *ngIf="selectedTestResult()!.dependencies.length > 0">
            <h4>üì¶ Depend√™ncias:</h4>
            <ul>
              <li *ngFor="let dep of selectedTestResult()!.dependencies">{{ dep }}</li>
            </ul>
          </div>

          <div class="test-code">
            <div class="test-code-header">
              <h4>üíª C√≥digo do Teste:</h4>
              <div class="test-code-actions">
                <button 
                  mat-raised-button
                  color="primary"
                  (click)="copyTestCode(selectedTestResult()!.testCode)"
                  title="Copiar c√≥digo"
                >
                  <mat-icon>content_copy</mat-icon>
                  Copiar
                </button>
                <button 
                  mat-raised-button
                  color="accent"
                  (click)="createTestFile(selectedTestResult()!)"
                  [disabled]="isCreatingTest()"
                  title="Criar arquivo de teste no projeto"
                >
                  <mat-icon>{{ isCreatingTest() ? 'hourglass_empty' : 'save' }}</mat-icon>
                  {{ isCreatingTest() ? 'Criando...' : 'Criar Teste' }}
                </button>
                <button 
                  mat-raised-button
                  color="primary"
                  (click)="executeTest(selectedTestResult()!)"
                  [disabled]="isExecutingTest() || !selectedTestResult()!.success"
                  title="Executar teste com Jest"
                >
                  <mat-icon>{{ isExecutingTest() ? 'hourglass_empty' : 'play_arrow' }}</mat-icon>
                  {{ isExecutingTest() ? 'Executando...' : 'Executar Teste' }}
                </button>
              </div>
            </div>
            <div class="code-container">
              <pre><code class="typescript">{{ formatTestCode(selectedTestResult()!.testCode) }}</code></pre>
            </div>
            
            <!-- Test Execution Section -->
            <div class="test-execution" *ngIf="selectedTestResult()!.testExecution">
              <div class="test-execution-header">
                <h4>üß™ Execu√ß√£o do Teste:</h4>
                <div class="execution-status">
                  <button 
                    *ngIf="selectedTestResult()!.testExecution!.status === 'error'"
                    mat-raised-button
                    color="warn"
                    (click)="regenerateTestFromExecutionError(selectedTestResult()!)"
                    [disabled]="isFixingTest() || fixingTestFile() === selectedTestResult()!.filePath"
                    title="Gerar novo teste corrigindo o erro de execu√ß√£o"
                    class="regenerate-button"
                  >
                    <mat-icon>{{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'hourglass_empty' : 'autorenew' }}</mat-icon>
                    {{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'Corrigindo...' : 'Corrigir com IA' }}
                  </button>
                  <span class="status-badge" [class]="getExecutionStatusClass(selectedTestResult()!.testExecution!.status)">
                    {{ getExecutionStatusText(selectedTestResult()!.testExecution!.status) }}
                  </span>
                </div>
              </div>
              <div class="execution-output">
                <pre class="output-content">{{ selectedTestResult()!.testExecution!.output }}</pre>
              </div>
            </div>
          </div>
        </div>

        <div class="result-error" *ngIf="!selectedTestResult()!.success">
          <div class="error-content">
            <div class="error-header">
              <mat-icon color="warn">error</mat-icon>
              <h4>Detalhes do Erro</h4>
            </div>
            <div class="error-message-box">
              <div class="error-label">Arquivo:</div>
              <div class="error-value">{{ selectedTestResult()!.filePath }}</div>
            </div>
            <div class="error-message-box" *ngIf="selectedTestResult()!.timestamp">
              <div class="error-label">Data/Hora:</div>
              <div class="error-value">{{ selectedTestResult()!.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}</div>
            </div>
            <div class="error-message-box">
              <div class="error-label">Mensagem de Erro:</div>
              <div class="error-text">{{ formatErrorMessage(selectedTestResult()!.error) }}</div>
            </div>
            <div class="error-actions">
              <button 
                mat-raised-button
                color="warn"
                (click)="retryTest(selectedTestResult()!)"
                [disabled]="isGeneratingTests()"
                title="Refazer teste"
              >
                <mat-icon>{{ isGeneratingTests() ? 'hourglass_empty' : 'refresh' }}</mat-icon>
                {{ isGeneratingTests() ? 'Refazendo...' : 'Refazer Teste' }}
              </button>
              <button 
                mat-raised-button
                color="accent"
                (click)="fixTestError(selectedTestResult()!)"
                [disabled]="isFixingTest() || fixingTestFile() === selectedTestResult()!.filePath"
                title="Melhorar teste com IA"
              >
                <mat-icon>{{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'hourglass_empty' : 'build' }}</mat-icon>
                {{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'Melhorando...' : 'Melhorar com IA' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Prompt Modal -->
  <div class="custom-prompt-modal" *ngIf="showCustomPromptDialog()" (click)="closeCustomPromptDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üîß Melhorar Teste com IA</h3>
        <button mat-icon-button (click)="closeCustomPromptDialog()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="prompt-section">
          <h5>üí¨ Instru√ß√µes para a IA:</h5>
          <p class="prompt-description">
            Descreva o que voc√™ gostaria que a IA fa√ßa com este teste. Seja espec√≠fico sobre as melhorias desejadas.
          </p>
          <textarea 
            [(ngModel)]="customPrompt"
            class="prompt-textarea"
            placeholder="Ex: Adicione mais casos de teste para edge cases, melhore a cobertura de c√≥digo, corrija os mocks, etc..."
            rows="6"
            (keydown.enter)="$event.preventDefault(); $event.stopPropagation(); processCustomPrompt()"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button 
            mat-raised-button
            color="warn"
            (click)="closeCustomPromptDialog()"
          >
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
          <button 
            mat-raised-button
            color="primary"
            (click)="processCustomPrompt()"
            [disabled]="!customPrompt().trim() || isFixingTest()"
          >
            <ng-container *ngIf="isFixingTest(); else rocketIcon">
              <mat-progress-spinner class="btn-spinner" mode="indeterminate" [diameter]="18" [strokeWidth]="3"></mat-progress-spinner>
              Processando...
            </ng-container>
            <ng-template #rocketIcon>
              <mat-icon>rocket_launch</mat-icon>
              Processar com IA
            </ng-template>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuration Modal -->
  <div class="config-modal" *ngIf="showConfigModal()" (click)="closeConfigModal()">
    <div class="modal-content config-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <mat-icon>settings</mat-icon>
          Configura√ß√£o do Sistema
        </h3>
        <button mat-icon-button (click)="closeConfigModal()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <mat-tab-group>
          <!-- Tab 1: Configura√ß√µes Gerais -->
          <mat-tab label="Geral">
            <div class="config-form">
              <mat-form-field appearance="fill">
                <mat-label>Ambiente</mat-label>
                <select matNativeControl [ngModel]="configNodeEnv()" (ngModelChange)="configNodeEnv.set($event)">
                  <option value="development">Development</option>
                  <option value="production">Production</option>
                </select>
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>Porta do Servidor</mat-label>
                <input matInput type="number" [ngModel]="configPort()" (ngModelChange)="configPort.set(+$event)">
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>CORS Origin</mat-label>
                <input matInput [ngModel]="configCorsOrigin()" (ngModelChange)="configCorsOrigin.set($event)">
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>N√≠vel de Log</mat-label>
                <select matNativeControl [ngModel]="configLogLevel()" (ngModelChange)="configLogLevel.set($event)">
                  <option value="debug">Debug</option>
                  <option value="info">Info</option>
                  <option value="warn">Warn</option>
                  <option value="error">Error</option>
                </select>
              </mat-form-field>
            </div>
          </mat-tab>

          <!-- Tab 2: Provedor de IA -->
          <mat-tab label="Provedor de IA">
            <div class="config-form">
              <mat-form-field appearance="fill">
                <mat-label>Provedor</mat-label>
                <select matNativeControl [ngModel]="configAiProvider()" (ngModelChange)="configAiProvider.set($event)">
                  <option value="openai">OpenAI</option>
                  <option value="stackspot">StackSpot</option>
                </select>
              </mat-form-field>

              <mat-form-field appearance="fill" *ngIf="configAiProvider() === 'openai'">
                <mat-label>OpenAI API Key</mat-label>
                <input matInput type="password" [ngModel]="configOpenaiKey()" (ngModelChange)="configOpenaiKey.set($event)">
                <mat-hint>Chave da API OpenAI</mat-hint>
              </mat-form-field>

              <div *ngIf="configAiProvider() === 'stackspot'" class="stackspot-config">
                <h4>Configura√ß√µes StackSpot</h4>
                <!-- Alerta informativo com link para cria√ß√£o de conta e agente -->
                <div class="config-info">
                  <mat-icon color="primary">info</mat-icon>
                  <span>
                    <p>Para utilizar o StackSpot, siga estes passos:</p>
                    <p>1) Acesse <a href="https://ai.stackspot.com/" target="_blank" rel="noopener">ai.stackspot.com</a> e crie sua conta.</p>
                    <p>2) Crie um Agente e copie o <strong>Client ID</strong> e o <strong>Client Key</strong>.</p>
                    <p>3) Preencha os campos abaixo. O <em>Realm</em> mais comum √© <code>stackspot-freemium</code>.</p>
                  </span>
                </div>

                <mat-form-field appearance="fill">
                  <mat-label>Client ID</mat-label>
                  <input matInput type="password" [ngModel]="configStackspotClientId()" (ngModelChange)="configStackspotClientId.set($event)">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Client Key</mat-label>
                  <input matInput type="password" [ngModel]="configStackspotClientKey()" (ngModelChange)="configStackspotClientKey.set($event)">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Realm</mat-label>
                  <input matInput [ngModel]="configStackspotRealm()" (ngModelChange)="configStackspotRealm.set($event)" placeholder="stackspot-freemium">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Token URL</mat-label>
                  <input matInput [ngModel]="configStackspotTokenUrl()" (ngModelChange)="configStackspotTokenUrl.set($event)">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Completions URL</mat-label>
                  <input matInput [ngModel]="configStackspotCompletionsUrl()" (ngModelChange)="configStackspotCompletionsUrl.set($event)">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Agent Chat URL</mat-label>
                  <input matInput [ngModel]="configStackspotAgentChatUrl()" (ngModelChange)="configStackspotAgentChatUrl.set($event)">
                </mat-form-field>
              </div>
            </div>
          </mat-tab>

          <!-- Tab 3: Avan√ßado -->
          <mat-tab label="Avan√ßado">
            <div class="config-form">
              <mat-form-field appearance="fill">
                <mat-label>Database URL</mat-label>
                <input matInput [ngModel]="configDatabaseUrl()" (ngModelChange)="configDatabaseUrl.set($event)">
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>JWT Secret</mat-label>
                <input matInput type="password" [ngModel]="configJwtSecret()" (ngModelChange)="configJwtSecret.set($event)">
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>User Agent</mat-label>
                <input matInput [ngModel]="configUserAgent()" (ngModelChange)="configUserAgent.set($event)">
              </mat-form-field>
            </div>
          </mat-tab>
        </mat-tab-group>

        <div class="config-info">
          <mat-icon color="primary">info</mat-icon>
          <span>As configura√ß√µes s√£o aplicadas automaticamente ap√≥s salvar. N√£o √© necess√°rio reiniciar o servidor.</span>
        </div>

        <!-- Feedback de salvamento -->
        <div class="config-save-feedback" *ngIf="configSaveMessage()">
          <div [class]="configSaveSuccess() ? 'save-success' : 'save-error'">
            <mat-icon>{{ configSaveSuccess() ? 'check_circle' : 'error' }}</mat-icon>
            <span>{{ configSaveMessage() }}</span>
          </div>
        </div>

        <div class="modal-actions">
          <button mat-raised-button color="warn" (click)="closeConfigModal()">
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
          <button mat-raised-button color="primary" (click)="saveConfig()" [disabled]="isSavingConfig()">
            <mat-icon>{{ isSavingConfig() ? 'hourglass_empty' : 'save' }}</mat-icon>
            {{ isSavingConfig() ? 'Salvando...' : 'Salvar Configura√ß√£o' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Footer -->
  <footer class="app-footer">
    <div class="footer-content">
      <span>Desenvolvido por <strong>iago_galdino@hotmail.com</strong></span>
    </div>
  </footer>

  <!-- All Tests Execution Modal -->
  <div class="test-details-modal" *ngIf="showAllTestsModal()" (click)="closeAllTestsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Execu√ß√£o de Todos os Testes</h3>
        <button mat-icon-button (click)="closeAllTestsModal()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="all-tests-execution" *ngIf="allTestsExecution()">
          <div 
            class="execution-output" 
            [ngClass]="getAllTestsExecutionStatusClass(allTestsExecution()!.status)"
            #allTestsOutputContainer
          >
            <pre class="output-content">{{ allTestsExecution()!.output }}</pre>
          </div>
        </div>
        <div class="no-data" *ngIf="!allTestsExecution()">Preparando execu√ß√£o...</div>
      </div>
    </div>
  </div>
</div>