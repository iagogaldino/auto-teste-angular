<div class="app-container">
  <!-- Header -->
  <mat-toolbar color="primary" class="app-header">
    <mat-toolbar-row>
      <span class="app-title">🧪 AutoUnitTest</span>
      <span class="spacer"></span>
      <mat-chip-listbox>
        <mat-chip [color]="isConnected() ? 'accent' : 'warn'">
          {{ isConnected() ? 'Conectado' : 'Desconectado' }}
        </mat-chip>
      </mat-chip-listbox>
    </mat-toolbar-row>
  </mat-toolbar>

  <!-- Status Messages -->
  <div class="status-section">
    <mat-card *ngIf="statusMessage()" class="status-card">
      <mat-card-content>
        <div class="status-content">
          <mat-icon color="primary">info</mat-icon>
          <span>{{ statusMessage() }}</span>
        </div>
      </mat-card-content>
    </mat-card>
    
    <mat-card *ngIf="errorMessage()" class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon color="warn">error</mat-icon>
          <span>{{ errorMessage() }}</span>
          <button mat-icon-button (click)="clearError()" class="clear-error">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Step 1: Directory Scan -->
    <mat-card class="step-card">
      <mat-card-header>
        <mat-card-title>
          <span class="step-number">1</span>
          <mat-icon>folder</mat-icon>
          Escanear Diretório
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="input-group">
          <mat-form-field appearance="outline" class="directory-input">
            <mat-label>Caminho do diretório</mat-label>
            <input 
              matInput
              [(ngModel)]="directoryPath" 
              placeholder="ex: C:\Users\...\src"
              [disabled]="isScanning()"
            >
          </mat-form-field>
          <button 
            mat-raised-button 
            color="primary"
            (click)="scanDirectory()" 
            [disabled]="isScanning() || !directoryPath().trim()"
            class="scan-button"
          >
            <mat-icon>{{ isScanning() ? 'refresh' : 'search' }}</mat-icon>
            {{ isScanning() ? 'Escaneando...' : 'Escanear' }}
          </button>
        </div>
        
        <!-- Scan Progress -->
        <div class="progress-section" *ngIf="scanProgress()">
          <mat-progress-bar 
            mode="determinate" 
            [value]="scanProgress()!.percentage"
            color="primary"
          ></mat-progress-bar>
          <div class="progress-text">
            {{ scanProgress()!.current }}/{{ scanProgress()!.total }} - {{ scanProgress()!.currentFile }}
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Step 2: Select Components -->
    <mat-card class="step-card" *ngIf="scannedComponents().length > 0">
      <mat-card-header>
        <mat-card-title>
          <span class="step-number">2</span>
          <mat-icon>description</mat-icon>
          Selecionar Componentes ({{ scannedComponents().length }} encontrados)
        </mat-card-title>
        <div class="step-actions">
          <button mat-raised-button (click)="selectAllFiles()" color="primary">
            <mat-icon>select_all</mat-icon>
            Todos
          </button>
          <button mat-raised-button (click)="clearSelection()" color="accent">
            <mat-icon>clear_all</mat-icon>
            Limpar
          </button>
        </div>
      </mat-card-header>
      
      <mat-card-content>
        <div class="selection-info">
          <mat-chip color="primary">
            <mat-icon>check_circle</mat-icon>
            {{ selectedFiles().length }} selecionados
          </mat-chip>
        </div>
        
        <mat-table [dataSource]="scannedComponents()" class="components-table">
          <!-- Checkbox Column -->
          <ng-container matColumnDef="select">
            <mat-header-cell *matHeaderCellDef>
              <mat-checkbox 
                [checked]="selectedFiles().length === scannedComponents().length && scannedComponents().length > 0"
                [indeterminate]="selectedFiles().length > 0 && selectedFiles().length < scannedComponents().length"
                (change)="toggleAllFiles()"
              ></mat-checkbox>
            </mat-header-cell>
            <mat-cell *matCellDef="let component">
              <mat-checkbox 
                [checked]="selectedFiles().includes(component.filePath)"
                (change)="toggleFileSelection(component.filePath)"
              ></mat-checkbox>
            </mat-cell>
          </ng-container>

          <!-- Component Name Column -->
          <ng-container matColumnDef="component">
            <mat-header-cell *matHeaderCellDef>Componente</mat-header-cell>
            <mat-cell *matCellDef="let component">
              <strong>{{ component.name }}</strong>
            </mat-cell>
          </ng-container>

          <!-- File Path Column -->
          <ng-container matColumnDef="file">
            <mat-header-cell *matHeaderCellDef>Arquivo</mat-header-cell>
            <mat-cell *matCellDef="let component">
              <span class="path-text">{{ component.filePath }}</span>
            </mat-cell>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <mat-header-cell *matHeaderCellDef>Tipo</mat-header-cell>
            <mat-cell *matCellDef="let component">
              <mat-chip [color]="component.isStandalone ? 'accent' : 'primary'">
                {{ component.isStandalone ? 'Standalone' : 'Regular' }}
              </mat-chip>
            </mat-cell>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <mat-header-cell *matHeaderCellDef>Ações</mat-header-cell>
            <mat-cell *matCellDef="let component">
              <button 
                mat-icon-button
                (click)="viewFileContent(component)" 
                title="Ver código"
                color="primary"
              >
                <mat-icon>visibility</mat-icon>
              </button>
              <button 
                mat-icon-button
                (click)="generateTestForComponent(component)"
                [disabled]="isCreatingTest()"
                title="Gerar teste"
                color="accent"
              >
                <mat-icon>{{ isCreatingTest() ? 'hourglass_empty' : 'auto_awesome' }}</mat-icon>
              </button>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="['select', 'component', 'file', 'type', 'actions']"></mat-header-row>
          <mat-row 
            *matRowDef="let row; columns: ['select', 'component', 'file', 'type', 'actions'];"
            [class.selected]="selectedFiles().includes(row.filePath)"
          ></mat-row>
        </mat-table>
      </mat-card-content>
    </mat-card>

    <!-- Step 3: Generate Tests -->
    <mat-card class="step-card" *ngIf="hasSelectedFiles()">
      <mat-card-header>
        <mat-card-title>
          <span class="step-number">3</span>
          <mat-icon>science</mat-icon>
          Gerar Testes Unitários
        </mat-card-title>
        <button 
          mat-raised-button
          color="primary"
          (click)="generateTests()" 
          [disabled]="!canGenerateTests()"
          class="generate-tests-btn"
        >
          <mat-icon>{{ isGeneratingTests() ? 'refresh' : 'rocket_launch' }}</mat-icon>
          {{ isGeneratingTests() ? 'Gerando...' : 'Gerar Testes' }}
        </button>
      </mat-card-header>

      <!-- Test Generation Progress -->
      <mat-card-content *ngIf="testProgress()">
        <div class="progress-section">
          <mat-progress-bar 
            mode="determinate" 
            [value]="testProgress()!.percentage"
            color="primary"
          ></mat-progress-bar>
          <div class="progress-text">
            {{ testProgress()!.current }}/{{ testProgress()!.total }} - {{ testProgress()!.currentFile }}
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Step 4: Test Results -->
    <mat-card class="step-card" *ngIf="testResults().length > 0">
      <mat-card-header>
        <mat-card-title>
          <span class="step-number">4</span>
          <mat-icon>assessment</mat-icon>
          Resultados dos Testes ({{ testResults().length }})
        </mat-card-title>
        <div class="results-summary">
          <mat-chip color="primary">
            <mat-icon>check_circle</mat-icon>
            {{ successCount() }} Sucessos
          </mat-chip>
          <mat-chip color="warn" *ngIf="errorCount() > 0">
            <mat-icon>error</mat-icon>
            {{ errorCount() }} Erros
          </mat-chip>
        </div>
      </mat-card-header>
      
      <mat-card-content>
        <mat-table [dataSource]="testResults()" class="test-results-table">
          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <mat-header-cell *matHeaderCellDef>Status</mat-header-cell>
            <mat-cell *matCellDef="let result">
              <mat-chip [color]="result.success ? 'primary' : 'warn'">
                <mat-icon>{{ result.success ? 'check_circle' : 'error' }}</mat-icon>
                {{ result.success ? 'Sucesso' : 'Erro' }}
              </mat-chip>
            </mat-cell>
          </ng-container>

          <!-- File Column -->
          <ng-container matColumnDef="file">
            <mat-header-cell *matHeaderCellDef>Arquivo</mat-header-cell>
            <mat-cell *matCellDef="let result">
              <div class="file-info">
                <div class="file-name">{{ getFileName(result.filePath) }}</div>
                <div class="file-path">{{ result.filePath }}</div>
              </div>
            </mat-cell>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <mat-header-cell *matHeaderCellDef>Ações</mat-header-cell>
            <mat-cell *matCellDef="let result">
              <div class="action-buttons">
                <button 
                  mat-icon-button
                  (click)="copyTestCode(result.testCode)"
                  title="Copiar código"
                  *ngIf="result.success"
                  color="primary"
                >
                  <mat-icon>content_copy</mat-icon>
                </button>
                <button 
                  mat-icon-button
                  (click)="createTestFile(result)"
                  [disabled]="isCreatingTest()"
                  title="Criar arquivo"
                  *ngIf="result.success"
                  color="accent"
                >
                  <mat-icon>{{ isCreatingTest() ? 'hourglass_empty' : 'save' }}</mat-icon>
                </button>
                <button 
                  mat-icon-button
                  (click)="executeTest(result)"
                  [disabled]="isExecutingTest() || !result.success"
                  title="Executar teste"
                  *ngIf="result.success"
                  color="primary"
                >
                  <mat-icon>{{ isExecutingTest() ? 'hourglass_empty' : 'play_arrow' }}</mat-icon>
                </button>
                <button 
                  mat-icon-button
                  (click)="retryTest(result)"
                  [disabled]="isGeneratingTests()"
                  title="Refazer teste"
                  *ngIf="!result.success"
                  color="warn"
                >
                  <mat-icon>{{ isGeneratingTests() ? 'hourglass_empty' : 'refresh' }}</mat-icon>
                </button>
                <button 
                  mat-icon-button
                  (click)="viewTestDetails(result)"
                  title="Ver detalhes"
                  color="primary"
                >
                  <mat-icon>visibility</mat-icon>
                </button>
              </div>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="['status', 'file', 'actions']"></mat-header-row>
          <mat-row *matRowDef="let row; columns: ['status', 'file', 'actions'];"></mat-row>
        </mat-table>
      </mat-card-content>
    </mat-card>

    <!-- Step 5: Execute All Tests -->
    <mat-card class="step-card" *ngIf="hasCreatedTests()">
      <mat-card-header>
        <mat-card-title>
          <span class="step-number">5</span>
          <mat-icon>play_arrow</mat-icon>
          Executar Todos os Testes
        </mat-card-title>
        <button 
          mat-raised-button
          color="accent"
          (click)="executeAllTests()" 
          [disabled]="isExecutingAllTests()"
          class="execute-all-tests-btn"
        >
          <mat-icon>{{ isExecutingAllTests() ? 'hourglass_empty' : 'play_arrow' }}</mat-icon>
          {{ isExecutingAllTests() ? 'Executando...' : 'Executar Todos' }}
        </button>
      </mat-card-header>

      <!-- All Tests Execution Progress -->
      <mat-card-content *ngIf="allTestsExecution()">
        <div class="all-tests-execution">
          <div class="execution-status">
            <span class="status-badge" [class]="getAllTestsExecutionStatusClass(allTestsExecution()!.status)">
              {{ getAllTestsExecutionStatusText(allTestsExecution()!.status) }}
            </span>
          </div>
          <div class="execution-output">
            <pre class="output-content">{{ allTestsExecution()!.output }}</pre>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

  <!-- Modals -->
  <!-- File Content Modal -->
  <div class="file-content-modal" *ngIf="fileContent()" (click)="closeFileContentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <mat-icon>code</mat-icon>
          Código do Arquivo: {{ getFileName(currentFilePath()) }}
        </h3>
        <button mat-icon-button (click)="closeFileContentModal()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="file-info-header">
          <mat-chip color="accent">
            <mat-icon>description</mat-icon>
            {{ currentFilePath() }}
          </mat-chip>
        </div>
        <div class="code-container">
          <pre><code>{{ fileContent() }}</code></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Details Modal -->
  <div class="test-details-modal" *ngIf="selectedTestResult()" (click)="closeTestDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalhes do Teste: {{ getFileName(selectedTestResult()!.filePath) }}</h3>
        <button mat-icon-button (click)="closeTestDetails()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="test-details-content" *ngIf="selectedTestResult()!.success">
          <div class="explanation">
            <h4>📝 Explicação:</h4>
            <p>{{ selectedTestResult()!.explanation }}</p>
          </div>

          <div class="test-cases" *ngIf="selectedTestResult()!.testCases.length > 0">
            <h4>🧪 Casos de Teste:</h4>
            <ul>
              <li *ngFor="let testCase of selectedTestResult()!.testCases">{{ testCase }}</li>
            </ul>
          </div>

          <div class="dependencies" *ngIf="selectedTestResult()!.dependencies.length > 0">
            <h4>📦 Dependências:</h4>
            <ul>
              <li *ngFor="let dep of selectedTestResult()!.dependencies">{{ dep }}</li>
            </ul>
          </div>

          <div class="test-code">
            <div class="test-code-header">
              <h4>💻 Código do Teste:</h4>
              <div class="test-code-actions">
                <button 
                  mat-raised-button
                  color="primary"
                  (click)="copyTestCode(selectedTestResult()!.testCode)"
                  title="Copiar código"
                >
                  <mat-icon>content_copy</mat-icon>
                  Copiar
                </button>
                <button 
                  mat-raised-button
                  color="accent"
                  (click)="createTestFile(selectedTestResult()!)"
                  [disabled]="isCreatingTest()"
                  title="Criar arquivo de teste no projeto"
                >
                  <mat-icon>{{ isCreatingTest() ? 'hourglass_empty' : 'save' }}</mat-icon>
                  {{ isCreatingTest() ? 'Criando...' : 'Criar Teste' }}
                </button>
                <button 
                  mat-raised-button
                  color="primary"
                  (click)="executeTest(selectedTestResult()!)"
                  [disabled]="isExecutingTest() || !selectedTestResult()!.success"
                  title="Executar teste com Jest"
                >
                  <mat-icon>{{ isExecutingTest() ? 'hourglass_empty' : 'play_arrow' }}</mat-icon>
                  {{ isExecutingTest() ? 'Executando...' : 'Executar Teste' }}
                </button>
              </div>
            </div>
            <div class="code-container">
              <pre><code class="typescript">{{ formatTestCode(selectedTestResult()!.testCode) }}</code></pre>
            </div>
            
            <!-- Test Execution Section -->
            <div class="test-execution" *ngIf="selectedTestResult()!.testExecution">
              <div class="test-execution-header">
                <h4>🧪 Execução do Teste:</h4>
                <div class="execution-status">
                  <button 
                    *ngIf="selectedTestResult()!.testExecution!.status === 'error'"
                    mat-raised-button
                    color="warn"
                    (click)="regenerateTestFromExecutionError(selectedTestResult()!)"
                    [disabled]="isFixingTest() || fixingTestFile() === selectedTestResult()!.filePath"
                    title="Gerar novo teste corrigindo o erro de execução"
                    class="regenerate-button"
                  >
                    <mat-icon>{{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'hourglass_empty' : 'autorenew' }}</mat-icon>
                    {{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'Corrigindo...' : 'Corrigir com IA' }}
                  </button>
                  <span class="status-badge" [class]="getExecutionStatusClass(selectedTestResult()!.testExecution!.status)">
                    {{ getExecutionStatusText(selectedTestResult()!.testExecution!.status) }}
                  </span>
                </div>
              </div>
              <div class="execution-output">
                <pre class="output-content">{{ selectedTestResult()!.testExecution!.output }}</pre>
              </div>
            </div>
          </div>
        </div>

        <div class="result-error" *ngIf="!selectedTestResult()!.success">
          <div class="error-content">
            <div class="error-header">
              <mat-icon color="warn">error</mat-icon>
              <h4>Detalhes do Erro</h4>
            </div>
            <div class="error-message-box">
              <div class="error-label">Arquivo:</div>
              <div class="error-value">{{ selectedTestResult()!.filePath }}</div>
            </div>
            <div class="error-message-box" *ngIf="selectedTestResult()!.timestamp">
              <div class="error-label">Data/Hora:</div>
              <div class="error-value">{{ selectedTestResult()!.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}</div>
            </div>
            <div class="error-message-box">
              <div class="error-label">Mensagem de Erro:</div>
              <div class="error-text">{{ formatErrorMessage(selectedTestResult()!.error) }}</div>
            </div>
            <div class="error-actions">
              <button 
                mat-raised-button
                color="warn"
                (click)="retryTest(selectedTestResult()!)"
                [disabled]="isGeneratingTests()"
                title="Refazer teste"
              >
                <mat-icon>{{ isGeneratingTests() ? 'hourglass_empty' : 'refresh' }}</mat-icon>
                {{ isGeneratingTests() ? 'Refazendo...' : 'Refazer Teste' }}
              </button>
              <button 
                mat-raised-button
                color="accent"
                (click)="fixTestError(selectedTestResult()!)"
                [disabled]="isFixingTest() || fixingTestFile() === selectedTestResult()!.filePath"
                title="Melhorar teste com IA"
              >
                <mat-icon>{{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'hourglass_empty' : 'build' }}</mat-icon>
                {{ isFixingTest() && fixingTestFile() === selectedTestResult()!.filePath ? 'Melhorando...' : 'Melhorar com IA' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Prompt Modal -->
  <div class="custom-prompt-modal" *ngIf="showCustomPromptDialog()" (click)="closeCustomPromptDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>🔧 Melhorar Teste com IA</h3>
        <button mat-icon-button (click)="closeCustomPromptDialog()" class="close-modal">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="modal-body">
        <div class="test-info" *ngIf="selectedTestForPrompt()">
          <div class="test-header">
            <h4>{{ getFileName(selectedTestForPrompt()!.filePath) }}</h4>
            <span class="test-status" [class]="selectedTestForPrompt()!.success ? 'success' : 'error'">
              {{ selectedTestForPrompt()!.success ? '✅ Sucesso' : '❌ Erro' }}
            </span>
          </div>
          
          <div class="error-section" *ngIf="!selectedTestForPrompt()!.success">
            <h5>🐛 Erro Encontrado:</h5>
            <div class="error-message">
              {{ selectedTestForPrompt()!.error }}
            </div>
          </div>

          <div class="test-code-preview">
            <h5>📝 Código do Teste Atual:</h5>
            <div class="code-preview">
              <pre><code class="typescript">{{ selectedTestForPrompt()!.testCode }}</code></pre>
            </div>
          </div>
        </div>

        <div class="prompt-section">
          <h5>💬 Instruções para a IA:</h5>
          <p class="prompt-description">
            Descreva o que você gostaria que a IA faça com este teste. Seja específico sobre as melhorias desejadas.
          </p>
          <textarea 
            [(ngModel)]="customPrompt"
            class="prompt-textarea"
            placeholder="Ex: Adicione mais casos de teste para edge cases, melhore a cobertura de código, corrija os mocks, etc..."
            rows="6"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button 
            mat-raised-button
            color="warn"
            (click)="closeCustomPromptDialog()"
          >
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
          <button 
            mat-raised-button
            color="primary"
            (click)="processCustomPrompt()"
            [disabled]="!customPrompt().trim() || isFixingTest()"
          >
            <mat-icon>{{ isFixingTest() ? 'hourglass_empty' : 'rocket_launch' }}</mat-icon>
            {{ isFixingTest() ? 'Processando...' : 'Processar com IA' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>